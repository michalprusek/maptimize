name: E2E Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/e2e-tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/e2e-tests.yml'
  workflow_dispatch: # Allow manual triggering

env:
  # Test user credentials for E2E tests
  # NOTE: For production, these should be GitHub Secrets (${{ secrets.TEST_USER_EMAIL }})
  # Using defaults here for initial setup - add secrets in repo settings for security
  TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL || 'test@maptimize.local' }}
  TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD || 'testpassword123' }}
  # Node settings
  NODE_VERSION: '20'

jobs:
  e2e-tests:
    name: Playwright E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install chromium --with-deps

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-browsers-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            playwright-browsers-${{ runner.os }}-

      # Start backend and database services
      - name: Set up Docker Compose
        run: |
          # Create minimal docker-compose for testing
          cat > docker-compose.test.yml << 'EOF'
          version: '3.8'
          services:
            db:
              image: pgvector/pgvector:pg16
              environment:
                POSTGRES_USER: maptimize
                POSTGRES_PASSWORD: maptimize
                POSTGRES_DB: maptimize
              ports:
                - "5433:5432"
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U maptimize"]
                interval: 5s
                timeout: 5s
                retries: 5

            redis:
              image: redis:alpine
              ports:
                - "6379:6379"
              healthcheck:
                test: ["CMD", "redis-cli", "ping"]
                interval: 5s
                timeout: 5s
                retries: 5
          EOF

      - name: Start database services
        run: |
          docker compose -f docker-compose.test.yml up -d
          # Wait for services to be healthy
          sleep 10

      - name: Setup Python for backend
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/pyproject.toml

      - name: Install backend dependencies
        working-directory: backend
        run: |
          pip install --upgrade pip
          pip install -e .

      - name: Initialize test database
        working-directory: backend
        env:
          DATABASE_URL: postgresql://maptimize:maptimize@localhost:5433/maptimize
        run: |
          # Run migrations or create tables
          python -c "from database import engine, Base; from models import *; Base.metadata.create_all(bind=engine)"

      - name: Create test user
        working-directory: backend
        env:
          DATABASE_URL: postgresql://maptimize:maptimize@localhost:5433/maptimize
          E2E_TEST_USER_EMAIL: ${{ env.TEST_USER_EMAIL }}
          E2E_TEST_USER_PASSWORD: ${{ env.TEST_USER_PASSWORD }}
        run: |
          python << 'PYTHON_SCRIPT'
          import os
          from database import engine
          from models.user import User
          from utils.security import hash_password
          from sqlalchemy.orm import Session

          test_email = os.environ.get('E2E_TEST_USER_EMAIL', 'test@maptimize.local')
          test_password = os.environ.get('E2E_TEST_USER_PASSWORD', 'testpassword123')

          with Session(engine) as db:
              # Check if test user exists
              user = db.query(User).filter(User.email == test_email).first()
              if not user:
                  user = User(
                      email=test_email,
                      name="Test User",
                      hashed_password=hash_password(test_password),
                      role="researcher"
                  )
                  db.add(user)
                  db.commit()
                  print("Test user created")
              else:
                  print("Test user already exists")
          PYTHON_SCRIPT

      - name: Start backend server
        working-directory: backend
        env:
          DATABASE_URL: postgresql://maptimize:maptimize@localhost:5433/maptimize
          REDIS_URL: redis://localhost:6379
          SECRET_KEY: test-secret-key-for-ci
          UPLOAD_DIR: /tmp/maptimize/uploads
        run: |
          mkdir -p /tmp/maptimize/uploads
          uvicorn main:app --host 0.0.0.0 --port 8000 &
          # Wait for backend to start
          sleep 10
          curl --retry 5 --retry-delay 2 --retry-connrefused http://localhost:8000/api/health || echo "Backend health check"

      - name: Build and start frontend
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8000
        run: |
          npm run build
          npm start &
          # Wait for frontend to start
          sleep 10
          curl --retry 5 --retry-delay 2 --retry-connrefused http://localhost:3000 || echo "Frontend check"

      - name: Run critical E2E tests
        working-directory: frontend
        env:
          BASE_URL: http://localhost:3000
          CI: true
        run: npm run test:e2e:critical

      - name: Run all E2E tests
        working-directory: frontend
        env:
          BASE_URL: http://localhost:3000
          CI: true
        run: npm run test:e2e
        continue-on-error: true # Don't fail the build on non-critical test failures

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: frontend/e2e/playwright-report/
          retention-days: 7

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results
          path: frontend/e2e/test-results/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.test.yml down -v
          pkill -f "uvicorn" || true
          pkill -f "next" || true

  # Quick smoke tests on PR (subset of tests)
  pr-smoke-tests:
    name: PR Smoke Tests
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright
        working-directory: frontend
        run: npx playwright install chromium --with-deps

      - name: Run critical tests only
        working-directory: frontend
        env:
          CI: true
        run: |
          # Run tests with mocked backend (no real backend needed for smoke tests)
          npm run test:e2e -- --grep @critical --project=chromium

      - name: Upload smoke test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-test-report
          path: frontend/e2e/playwright-report/
          retention-days: 3
